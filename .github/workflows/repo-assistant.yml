name: Repo Assistant Commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: read       # è¯»ä»£ç 
  issues: write        # å›å¸–
  pull-requests: write

jobs:
  show_or_ls:
    # åªå…è®¸ä»“åº“æˆå‘˜/åä½œè€…è§¦å‘ï¼Œä¸”åªå¤„ç† /show å’Œ /ls å‘½ä»¤
    if: >
      (startsWith(github.event.comment.body, '/show ') ||
       startsWith(github.event.comment.body, '/ls ')) &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    steps:
      - name: Run command
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            const body = context.payload.comment.body.trim();

            async function comment(text) {
              await github.rest.issues.createComment({
                owner, repo, issue_number, body: text
              });
            }

            // å–é»˜è®¤åˆ†æ”¯
            const repoInfo = await github.rest.repos.get({owner, repo});
            const ref = repoInfo.data.default_branch;

            if (body.startsWith('/ls ')) {
              const path = body.slice(4).trim() || '.';
              try {
                const res = await github.rest.repos.getContent({owner, repo, path, ref});
                if (!Array.isArray(res.data)) {
                  await comment(`\`${path}\` ä¸æ˜¯ç›®å½•ã€‚`);
                  return;
                }
                const rows = res.data
                  .map(e => `${e.type === 'dir' ? 'ğŸ“' : 'ğŸ“„'} ${e.name}`)
                  .join('\n');
                await comment(`**ç›®å½• ${path} (@${ref})**\n\n${rows || '_ç©º_'}\n`);
              } catch (e) {
                await comment(`è¯»å–ç›®å½•å¤±è´¥ï¼š${e.message}`);
              }
              return;
            }

            if (body.startsWith('/show ')) {
              // æ ¼å¼ï¼š/show path/to/file[:start-end]
              const arg = body.slice(6).trim();
              let m = arg.match(/^(.+?):(\d+)-(\d+)$/);
              let path, start, end;
              if (m) { path = m[1]; start = +m[2]; end = +m[3]; }
              else { path = arg; }

              try {
                const res = await github.rest.repos.getContent({owner, repo, path, ref});
                if (Array.isArray(res.data) || res.data.type !== 'file') {
                  await comment(`\`${path}\` ä¸æ˜¯æ™®é€šæ–‡ä»¶ã€‚`);
                  return;
                }
                const content = Buffer.from(res.data.content, res.data.encoding).toString('utf8');
                let out = content;
                if (start && end) {
                  const lines = content.split('\n');
                  const s = Math.max(1, start);
                  const e = Math.min(lines.length, end);
                  out = lines.slice(s-1, e).map((l, i) => `${s+i}  ${l}`).join('\n');
                }
                // é™åˆ¶ä¸€æ¬¡è¿”å›çš„é•¿åº¦ï¼Œé¿å…è¶…é•¿è¯„è®º
                const MAX = 55000;
                if (out.length > MAX) out = out.slice(0, MAX) + '\n... (æˆªæ–­)';

                await comment(`**${path} @ ${ref}**\n\n\`\`\`\n${out}\n\`\`\``);
              } catch (e) {
                await comment(`è¯»å–æ–‡ä»¶å¤±è´¥ï¼š${e.message}`);
              }
              return;
            }
